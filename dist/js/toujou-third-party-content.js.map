{"version":3,"file":"toujou-third-party-content.js","sources":["../../src/components/copied/toujou-third-party-content/toujou-third-part-content.styles.js","../../src/components/copied/toujou-third-party-content/toujou-third-party-content.js"],"sourcesContent":["import { css } from 'lit';\n\nexport const ToujouThirdPartyContentStyles = css`\n  :host {\n    display: var(--toujou-third-party-content-display, flex);\n    align-items: var(--toujou-third-party-content-align-items, stretch);\n    justify-content: var(--toujou-third-party-content-justify-content, center);\n    flex-direction: var(--toujou-third-party-content-flex-direction, column);\n    position: var(--toujou-third-party-content-position, relative);\n    top: var(--toujou-third-party-content-top, 0);\n    left: var(--toujou-third-party-content-left, 0);\n    height: var(--toujou-third-party-content-height, 100%);\n    width: var(--toujou-third-party-content-width, 100%);\n  }\n\n  :host([contenttype='maps']) {\n    position: var(--toujou-third-party-content-maps-position, absolute);\n  }\n\n  iframe {\n    border: var(--toujou-third-party-content-iframe-border, none);\n    position: var(--toujou-third-party-content-iframe-position, absolute);\n    height: var(--toujou-third-party-content-iframe-height, 100%);\n    width: var(--toujou-third-party-content-iframe-width, 100%);\n  }\n\n  :host([contenttype='html']) iframe {\n    position: var(--toujou-third-party-content-html-iframe-position, relative);\n  }\n`;","import { LitElement, html } from 'lit';\nimport { ToujouThirdPartyContentStyles } from \"./toujou-third-part-content.styles.js\";\n\nimport { consentsStore } from '../toujou-consent-widget/consentsStore';\nimport { saveSingleConsent } from '../toujou-consent-widget/actions/consent-actions';\n\nclass ToujouThirdPartyContent extends LitElement {\n  static get is() {\n    return 'toujou-third-party-content';\n  }\n\n  static styles = [ ToujouThirdPartyContentStyles ];\n\n  static get styles() {\n    return styles;\n  }\n\n  render() {\n    return html`\n      <slot id=\"templatedContent\" @slotchange=\"${this._handleSlotChange}\"></slot>\n      <div @click=\"${this._handlePlaceholderClick}\">\n        <slot name=\"placeholder\" id=\"placeholderContainer\" class=\"placeholder-slot\"></slot>\n      </div>\n    `;\n  }\n\n  static get properties() {\n    return {\n      contentType: {\n        type: String,\n      },\n      contentTypeAllowed: {\n        type: Boolean,\n      },\n      contentID: {\n        type: String,\n      },\n      isIntersecting: {\n        type: Boolean,\n      },\n      show: {\n        type: Boolean,\n      },\n    };\n  }\n\n  constructor(props) {\n    super(props);\n\n    this.onStateChange = this.onStateChange.bind(this);\n    this._handleConsentButtonClick = this._handleConsentButtonClick.bind(this);\n\n    this.store = consentsStore;\n    this.store.subscribe(this.onStateChange);\n    this._state = this.store.getState();\n\n    this.contentTypeAllowed = false;\n    this.isIntersecting = false;\n    this.show = false;\n  }\n\n  /**\n   * This function fires when the component is appended to the document.\n   */\n  connectedCallback() {\n    super.connectedCallback();\n    this._isContentTypeAllowed();\n    this._checkIfShouldShow();\n    this._addEventListeners();\n    this._addIntersectionObserver();\n  }\n\n  /**\n   * This function runs each time a property is updated.\n   * We have to check of the element is intersecting with the viewport,\n   * so we load when only if visible\n   */\n  updated(_changedProperties) {\n    _changedProperties.forEach((oldValue, propertyName) => {\n      if (propertyName === 'isIntersecting' && this.isIntersecting && !this.show) {\n        this.show = true;\n        this._checkIfShouldShow();\n      }\n    });\n  }\n\n  /**\n   * This function runs each time the store changes\n   */\n  onStateChange() {\n    this._state = this.store.getState();\n    this._isContentTypeAllowed();\n    this._checkIfShouldShow();\n  }\n\n  /**\n   * Add event listeners to the element.\n   * Check if the cookies have been updated\n   */\n  _addEventListeners() {\n    window.addEventListener('toujou-consent-widget-dismissed', () => {\n      this._isContentTypeAllowed();\n      this._checkIfShouldShow();\n    });\n    window.addEventListener('toujou-consent-button-clicked', this._handleConsentButtonClick);\n  }\n\n  /**\n   * If the 'always allow' button is clicked, we should set the consent for that content type\n   * and show a snackbar confirming it.\n   */\n  _handleConsentButtonClick(event) {\n    const dispatcherConsent = event.target;\n    const childConsents = this.querySelectorAll('.consent');\n    childConsents.forEach((childConsent) => {\n      if (childConsent === dispatcherConsent) {\n        this._saveSingleConsent(event.target.getAttribute('consenttype'), this._createNewConsentData(event.target));\n        this._dispatchAddSnackbar(event.target.getAttribute('snackbarmessage'));\n      }\n    });\n  }\n\n  /**\n   * Create the new consent data for a consentType\n   * It returns an object ready to be dispatched to the store\n   */\n  // eslint-disable-next-line class-methods-use-this\n  _createNewConsentData(consentElement) {\n    const elementLifetimeValue = consentElement.getAttribute('consentLifetime');\n    const consentLifetime = elementLifetimeValue * 24 * 60 * 60;\n\n    return {\n      consentGiven: true,\n      consentCreationDate: Date.now(),\n      consentExpirationDate: Date.now() + consentLifetime,\n      consentLifetime,\n    };\n  }\n\n  /**\n   * Call store action to update values of one single consent type\n   */\n  _saveSingleConsent(consentType, consentData) {\n    this.store.dispatch(saveSingleConsent(consentType, consentData));\n  }\n\n  /**\n   * Dispatch event to add a snackbar\n   */\n  _dispatchAddSnackbar(snackbarMessage) {\n    const addSnackbarEvent = new CustomEvent('toujou-add-snackbar', {\n      bubbles: true,\n      composed: true,\n      detail: {\n        message: snackbarMessage,\n        type: 'auto',\n        duration: 2500,\n        variant: 'success',\n      },\n    });\n    this.dispatchEvent(addSnackbarEvent);\n  }\n\n  /**\n   * Handle click on a button in the placeholder slot\n   */\n  _handlePlaceholderClick(event) {\n    if (event.target.hasAttribute('ttpc-showcontentonce')) {\n      this._handleShowContentOnceClick();\n    }\n  }\n\n  /**\n   * There is a button to show the content once without setting any consent 'cookies'\n   * A click on this button should just show the content\n   */\n  _handleShowContentOnceClick() {\n    this._showContent();\n  }\n\n  /**\n   * Add an Intersection Observer to check if the element is visible\n   */\n  _addIntersectionObserver() {\n    // eslint-disable-next-line no-shadow\n    const observer = new IntersectionObserver((entry, observer) => {\n      this.isIntersecting = entry[0].isIntersecting;\n      if (this.isIntersecting) {\n        observer.unobserve(this);\n      }\n    });\n    observer.observe(this);\n  }\n\n  /**\n   * Append all elements (other that <script>) to the page\n   */\n  _appendNonScriptTag(templateTag) {\n    this.querySelector('.toujou-third-party-content__templated-content').appendChild(templateTag);\n  }\n\n  /**\n   * Append script element to the page\n   * We need to make sure external scripts are completely loaded\n   * before we can proceed to the next element\n   */\n  _appendScriptTag(templateTag) {\n    const newScript = document.createElement('script');\n    const readyScript = this._copyScriptAttributesAndContent(templateTag, newScript);\n\n    this.querySelector('.toujou-third-party-content__templated-content').appendChild(readyScript);\n\n    if (!readyScript.hasAttribute('src') || readyScript.hasAttribute('async') || readyScript.hasAttribute('defer')) {\n      return new Promise((resolve) => {\n        resolve();\n      });\n    }\n\n    return new Promise((resolve) => {\n      readyScript.addEventListener('load', resolve);\n    });\n  }\n\n  /**\n   * Append elements inside the templated content in an asyncronous way\n   * so we can ensure the order in which the scripts are added and executed\n   */\n  async _appendTags(templateTags) {\n    for (let i = 0; i < templateTags.length; i++) {\n      // eslint-disable-next-line no-await-in-loop\n      await new Promise((resolve) => {\n        if (templateTags[i].tagName !== 'SCRIPT') {\n          resolve(this._appendNonScriptTag(templateTags[i]));\n        } else {\n          resolve(this._appendScriptTag(templateTags[i]));\n        }\n      });\n    }\n  }\n\n  /**\n   * Check if the element should show the external content\n   */\n  _checkIfShouldShow() {\n    if (this.contentTypeAllowed && this.show) {\n      this._showContent();\n    }\n  }\n\n  /**\n   * Clear the #renderedContent slot.\n   * This is used before we rerender the template,\n   * so are are sure we always have the most recent template content\n   */\n  _clearRenderedContent() {\n    this.querySelector('.toujou-third-party-content__templated-content').innerHTML = '';\n  }\n\n  /**\n   * Copy attributes and content from old script (from the template) to the readyScript (\"clone\")\n   */\n  // eslint-disable-next-line class-methods-use-this\n  _copyScriptAttributesAndContent(oldScript, readyScript) {\n    for (let i = 0; i < oldScript.attributes.length; i++) {\n      const attr = oldScript.attributes[i];\n      readyScript.setAttribute(attr.name, attr.value);\n    }\n    // eslint-disable-next-line no-param-reassign\n    readyScript.innerHTML = oldScript.innerHTML;\n    return readyScript;\n  }\n\n  /**\n   * Separate the uncommentedTemplateContent into an array of html elements (by Tag)\n   */\n  // eslint-disable-next-line class-methods-use-this\n  _getTemplateTags(uncommentedTemplateContent) {\n    const templateTags = [];\n    const dummyDiv = document.createElement('div');\n    dummyDiv.innerHTML = uncommentedTemplateContent;\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const key in dummyDiv.childNodes) {\n      // eslint-disable-next-line max-len\n      if (dummyDiv.childNodes[key].nodeType !== 3 && dummyDiv.childNodes[key].parentElement === dummyDiv) {\n        templateTags.push(dummyDiv.childNodes[key]);\n      }\n    }\n\n    return templateTags;\n  }\n\n  /**\n   * This function run each time a change in the #templatedContent slot is detected\n   */\n  _handleSlotChange() {\n    this._checkIfShouldShow();\n  }\n\n  /**\n   * Check if the template content is commented out\n   */\n  // eslint-disable-next-line class-methods-use-this\n  _isCommentedTemplate(templateHTML) {\n    return templateHTML.startsWith('<!--') && templateHTML.endsWith('-->');\n  }\n\n  /**\n   * Check if the content type is allowed\n   * (if cookie exists and is true)\n   */\n  _isContentTypeAllowed() {\n    if (this._state.consents[this.contentType]) {\n      this.contentTypeAllowed = this._state.consents[this.contentType].consentGiven || false;\n    } else {\n      this.contentTypeAllowed = false;\n    }\n    if (window.location.hash === '#aaa') {\n      this.contentTypeAllowed = true;\n    }\n  }\n\n  /**\n   * Show the external content\n   */\n  _showContent() {\n    this._clearRenderedContent();\n\n    const templates = this.shadowRoot\n      .querySelector('#templatedContent')\n      .assignedNodes({ flatten: true })\n      .filter((el) => el.tagName === 'TEMPLATE');\n\n\n    templates.forEach((template) => {\n      if (this.contentType === 'html') {\n        const uncommentedTemplateContent = this._uncommentTemplate(template);\n        const templateTags = this._getTemplateTags(uncommentedTemplateContent);\n        this._appendTags(templateTags);\n      } else {\n        const clone = document.importNode(template.content, true);\n        this.querySelector('.toujou-third-party-content__templated-content').appendChild(clone);\n      }\n    });\n\n    this.setAttribute('showingcontent', '');\n  }\n\n  /**\n   * Remove the comment marks from the template content\n   */\n  _uncommentTemplate(template) {\n    return this._isCommentedTemplate(template.innerHTML)\n      ? template.innerHTML.substr(4, template.innerHTML.length - 7)\n      : null;\n  }\n}\n\ncustomElements.define(ToujouThirdPartyContent.is, ToujouThirdPartyContent);\n"],"names":["ToujouThirdPartyContentStyles","css","ToujouThirdPartyContent","LitElement","html","props","consentsStore","_changedProperties","oldValue","propertyName","event","dispatcherConsent","childConsent","consentElement","consentLifetime","consentType","consentData","saveSingleConsent","snackbarMessage","addSnackbarEvent","entry","observer","templateTag","newScript","readyScript","resolve","templateTags","i","oldScript","attr","uncommentedTemplateContent","dummyDiv","key","templateHTML","el","template","clone","__publicField"],"mappings":"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"}